def get_gtf_file(wildcards):
	sci_species_name = config['sci_species_name'][wildcards.species]
        genome_build = config['genome_build'][wildcards.species]

        return ( 'data/' + sci_species_name + '.' + genome_build + '.{}.mod.chr.gtf'.format(config['ensembl_release'])  )

def get_dna_file(wildcards):
        if wildcards.species == 'hsa':
                return("data/Homo_sapiens.GRCh38.dna.primary_assembly.fa")
        if wildcards.species == 'mmu':
                return("data/Mus_musculus.GRCm38.dna.primary_assembly.fa")

rule index_maf_files:
	input:
	   maf="data/maf_{species}/chr{chrom}.maf",
	output:
	   protected("data/{species}_chr{chrom}.mafindex")
	conda: 'envs/biopython.yaml'
	benchmark:
           "benchmarks/{species}_chr{chrom}.mafindex.log"
	script:
	   "biopython_maf_processing.py"

rule get_transcript_ids:
        input:
                gtf=get_gtf_file
        output: "results/bed/{species}_chr{chrom}_all_transcripts.txt"
        shell: "exe/get_all_transcripts.sh {input} {wildcards.chrom} > {output}"

rule gtf_to_bed_CDS:
        input:
            gtf=get_gtf_file,
            script="exe/pre-processing/gtf_to_bed.sh"
        output:
            "results/bed/{species}_{tissue}_CDS.chr{chrom}.tmp.bed"
        conda:
            "envs/biopython.yaml"
        shell:
            "{input.script} {input.gtf} CDS {wildcards.chrom} {output}"

rule filter_bed_file:
	input: "results/bed/{species}_{tissue}_CDS.chr{chrom}.tmp.bed"
	output: "results/bed/{species}_{tissue}_CDS.chr{chrom}.bed"
	script: "filter_bed6.R" 

rule gtf_to_bed_no_reannotation:
        input:
            gtf=get_gtf_file,
            script="exe/pre-processing/gtf_to_bed.sh"
        output:
            "results/bed/no_reannotation/{species}_{feature}.chr{chrom}.bed"
        conda:
            "envs/biopython.yaml"
        shell:
            "{input.script} {input.gtf} {wildcards.feature} {wildcards.chrom} {output}"

#rule split_bed:
#        input:
#                "results/bed/{species}_{tissue}.utr.full.bed"
#        output:
#                "results/bed/{species}_{tissue}_3UTR.chr{chrom}.bed"
#        shell:
#                'grep -P "^{wildcards.chrom}\t" {input} > {output}'

rule get_utr_lengths:
        input:  'results/bed/{species}_{tissue}_3UTR.bed'
        output: 'results/utrs/{species}_{tissue}.utr.lengths.tsv'
        script: 'get_utr_lengths.R'
